---
import { getCollectionProducts } from "../../utils/shopify";
import { setCache } from "../../utils/cache";

import BaseLayout from "../../layouts/BaseLayout.astro";
import NotFoundLayout from "../../layouts/NotFoundLayout.astro";
import ProductCard from "../../components/ProductCard.astro";

const { handle } = Astro.params;
const headers = Astro.request.headers;
const forwardedFor =
  headers.get("x-nf-client-connection-ip") || headers.get("x-forwarded-for");
const ip = forwardedFor?.split(",")[0]?.trim() || Astro.clientAddress;

const collection = await getCollectionProducts({
  handle: handle || "",
  limit: 24,
  buyerIP: ip,
});

if (!collection) {
  Astro.response.status = 404;
}

setCache.short(Astro);
---

{
  !collection ? (
    <NotFoundLayout
      title="Collection not found"
      message="The collection you're looking for doesn't exist."
    />
  ) : (
    <BaseLayout title={collection.title}>
      <section class="container py-12">
        <div class="mb-10">
          <nav class="mb-4">
            <ol class="flex items-center gap-2 text-xs text-ink/60">
              <li>
                <a href="/" class="hover:text-ink">
                  Home
                </a>
              </li>
              <li>/</li>
              <li>
                <a href="/collections" class="hover:text-ink">
                  Collections
                </a>
              </li>
              <li>/</li>
              <li class="text-ink">{collection.title}</li>
            </ol>
          </nav>
          <h1 class="text-4xl font-semibold tracking-tight sm:text-5xl">
            {collection.title}
          </h1>
          {collection.description && (
            <p class="mt-3 max-w-2xl text-ink/70">
              {collection.description}
            </p>
          )}
          <p class="mt-2 text-sm text-ink/50">
            {collection.products.length} product{collection.products.length !== 1 ? "s" : ""}
          </p>
        </div>

        {collection.products.length > 0 ? (
          <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            {collection.products.map((product) => (
              <ProductCard product={product} />
            ))}
          </div>
        ) : (
          <div class="py-20 text-center">
            <p class="text-lg text-ink/60">No products in this collection yet.</p>
            <a href="/" class="button mt-6 inline-flex">
              Continue Shopping
            </a>
          </div>
        )}
      </section>
    </BaseLayout>
  )
}
